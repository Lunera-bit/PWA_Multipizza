<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/carrito"></ion-back-button>
    </ion-buttons>
    <ion-title>Carrito</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- PASO 1: Productos -->
  <div *ngIf="currentStep === 1">
    <h2>
      <span class="step-number">1</span> Productos
    </h2>
    <ion-list *ngIf="items && items.length > 0">
      <ion-item *ngFor="let it of items">
        <ion-label>
          <h3>
            {{ it.title }}
            <span class="size-tag" *ngIf="it.size">({{ getSizeLabel(it.size) }})</span>
          </h3>
          <p>Cantidad: {{ it.qty }}</p>
          <p>Precio c/u: S/. {{ it.price | number:'1.2-2' }}</p>
        </ion-label>
        <div slot="end">
          <strong>S/. {{ (it.price || 0) * (it.qty || 0) | number:'1.2-2' }}</strong>
        </div>
      </ion-item>
    </ion-list>
    <div style="margin-top: 20px;">
      <h3>Total: <strong style="color: #3880ff;"> S/. {{ total | number:'1.2-2' }}</strong></h3>
    </div>
  </div>

  <!-- PASO 2: Datos -->
  <div *ngIf="currentStep === 2">
    <h2>
      <span class="step-number">2</span> Datos
    </h2>
    <ion-item>
      <ion-icon name="person" slot="start"></ion-icon>
      <ion-label position="floating">Nombre</ion-label>
      <ion-input [(ngModel)]="userName" type="text"></ion-input>
    </ion-item>
    <ion-item>
      <ion-icon name="mail" slot="start"></ion-icon>
      <ion-label position="floating">Email</ion-label>
      <ion-input [(ngModel)]="userEmail" type="email"></ion-input>
    </ion-item>
    <ion-item>
      <ion-icon name="call" slot="start"></ion-icon>
      <ion-label position="floating">Celular</ion-label>
      <ion-input [(ngModel)]="userPhone" type="tel"></ion-input>
    </ion-item>
  </div>

  <!-- PASO 3: Indicaciones extra -->
  <div *ngIf="currentStep === 3">
    <h2>
      <span class="step-number">3</span> Indicaciones extra
    </h2>
    <ion-item>
      <ion-label position="floating">Indicaciones especiales</ion-label>
      <ion-textarea [(ngModel)]="instructions" placeholder="Ej: Sin cebolla, extra queso, etc."></ion-textarea>
    </ion-item>
  </div>

  <!-- PASO 4: Direcci贸n de entrega -->
  <div *ngIf="currentStep === 4">
    <h2>
      <span class="step-number">4</span> Direcci贸n de entrega
    </h2>
    
    <!-- Mapa Mapbox -->
    <div #mapContainer id="map" style="width: 100%; height: 400px; border-radius: 8px; margin-bottom: 16px;"></div>

    <ion-item>
      <ion-label position="floating">Direcci贸n</ion-label>
      <ion-input [(ngModel)]="address" type="text" placeholder="Ingrese la Direcci贸n"></ion-input>
    </ion-item>

    <ion-item>
      <ion-label position="floating">Detalles (apto, referencias, etc.)</ion-label>
      <ion-textarea [(ngModel)]="addressDetails"></ion-textarea>
    </ion-item>

    <div style="margin-top: 16px;">
      <ion-button expand="block" fill="outline" (click)="setLocation()">
        <ion-icon name="pin" slot="start"></ion-icon>
        Usar mi ubicaci贸n actual
      </ion-button>
    </div>

    <p *ngIf="latitude && longitude" style="font-size: 0.9rem; color: #666; margin-top: 12px;">
       Lat: {{ latitude | number:'1.4-4' }}, Lng: {{ longitude | number:'1.4-4' }}
    </p>
  </div>

  <!-- PASO 5: Confirmaci贸n -->
  <div *ngIf="currentStep === 5">
    <h2>
      <span class="step-number">5</span> Confirmaci贸n
    </h2>

    <ion-item lines="none" class="summary-item">
      <ion-icon name="cart" slot="start" color="primary"></ion-icon>
      <ion-label>
        <strong>Total</strong>
        <p>S/. {{ total | number:'1.2-2' }}</p>
      </ion-label>
    </ion-item>

    <ion-item lines="none" class="summary-item">
      <ion-icon name="person" slot="start" color="primary"></ion-icon>
      <ion-label>
        <strong>Datos</strong>
        <p>{{ userName }} ({{ userEmail }})</p>
        <p>{{ userPhone }}</p>
      </ion-label>
    </ion-item>

    <ion-item lines="none" class="summary-item">
      <ion-icon name="chatbubbles" slot="start" color="primary"></ion-icon>
      <ion-label>
        <strong>Indicaciones extra</strong>
        <p>{{ instructions || 'Ninguna' }}</p>
      </ion-label>
    </ion-item>

    <ion-item lines="none" class="summary-item">
      <ion-icon name="location" slot="start" color="primary"></ion-icon>
      <ion-label>
        <strong>Direcci贸n de entrega</strong>
        <p>{{ address }}</p>
        <p *ngIf="addressDetails">{{ addressDetails }}</p>
      </ion-label>
    </ion-item>

    <div style="margin-top: 24px;">
      <ion-button expand="block" color="primary" (click)="placeOrder()">
        Confirmar pedido
      </ion-button>
    </div>
  </div>

  <!-- Botones de navegaci贸n -->
  <div class="button-group" style="margin-top: 32px; display: flex; gap: 12px;">
    <ion-button expand="block" fill="outline" (click)="prevStep()" [disabled]="currentStep === 1">
      <ion-icon name="arrow-back" slot="start"></ion-icon>
      Retroceder
    </ion-button>
    <ion-button expand="block" fill="outline" (click)="nextStep()" [disabled]="currentStep === 5">
      Siguiente
      <ion-icon name="arrow-forward" slot="end"></ion-icon>
    </ion-button>
  </div>
</ion-content>
